Bootstrap: localimage
From: images/ccake.sif

%environment
    export LC_ALL=C

%post
    
    apt-get install -y gdb curl zsh openssh-server bash
    #sed -i 's/#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
    #sed -i 's/#PubkeyAuthetication.*/PubkeyAuthetication yes/' /etc/ssh/sshd_config
    #sed -i 's/#AuthorizedKeysFile/AuthorizedKeysFile yes/' /etc/ssh/sshd_config
    #service ssh restart

    # Define environment variables needed for install
    CABANASRC=/usr/local/src/cabana
    KOKKOSSRC=/usr/local/src/kokkos
    PREFIX=/usr/local

    # Now we need to build and install Kokkos and Cabana
    cd $KOKKOSSRC/build
    cmake -DCMAKE_INSTALL_PREFIX=$PREFIX \
          -DCMAKE_CXX_COMPILER=g++ \
          -DCMAKE_CXX_STANDARD=17 \
          -DCMAKE_CXX_EXTENSIONS=Off \
          -DCMAKE_BUILD_TYPE="Debug" \
          -DKokkos_ENABLE_COMPILER_WARNINGS=ON \
          -DKokkos_ENABLE_CUDA=Off \
          -DKokkos_ENABLE_CUDA_LAMBDA=Off \
          -DKokkos_ENABLE_OPENMP=On \
          -DKokkos_ENABLE_SERIAL=On \
          -DKokkos_ENABLE_TESTS=Off \
          -DKokkos_ARCH_SKX=Off $KOKKOSSRC

    cmake --build . --target install -j

    cd $CABANASRC/build
    cmake -D CMAKE_BUILD_TYPE="Debug" \
          -D CMAKE_CXX_STANDARD=17 \
          -D CMAKE_PREFIX_PATH=$CABANASRC \
          -D CMAKE_INSTALL_PREFIX=$PREFIX \
          -D CMAKE_CXX_COMPILER=g++\
          -D Cabana_REQUIRE_CUDA=OFF \
          -D Cabana_ENABLE_TESTING=OFF \
          -D Cabana_ENABLE_EXAMPLES=OFF $CABANASRC

    cmake --build . --target install -j

    # QoL for developers
    chsh -s /usr/bin/zsh root
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended

